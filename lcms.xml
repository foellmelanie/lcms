<!--
    wl-28-05-2019, Tue: commence
    wl-30-05-2019, Thu: XML works. use 'ln -sf' to override the existed one
-->
<tool id="lcms" name="lcms" version="0.1.0">
  <description>
    Deisotyping and annotating of LC-MS data
  </description>
  <macros>
    <import>macros.xml</import>
  </macros>
  <expand macro="requirements" />
  <expand macro="stdio" />

  <!-- =============================================================== -->
  <command detect_errors="exit_code">
    <![CDATA[
      #if $process.process_selector:
        #for $file in $process.mzxml_file:
          #if $file.is_of_type("mzxml")
            ln -sf ${file} ${file}.mzXML &&
          #else
            ln -sf ${file} ${file}.mzML &&
          #end if  
        #end for
      #end if

      Rscript ${__tool_directory__}/lcms.R

        --process $process.process_selector      

        #if $process.process_selector:
          --mzxml_file '$process.mzxml_file' 
          --samp_name ${','.join([a.name for a in $process.mzxml_file])}  
          --FWHM '$process.FWHM'
          --snthresh '$process.snthresh'
          --profmethod '$process.profmethod'
          --minfrac '$process.minfrac'
          --rdata '$process.rdata'
          #if $process.rdata:
            --rdata_out '$rdata_out'
          #end if
        #else:
          --xset_file '$process.xset_file' 
        #end if

        ## Making library
        --ionisation_mode '$make_library.ionisation_mode'
        --fixed '$make_library.fixed'
        --fixed_FA '$make_library.fixed_FA'
        
        ## deisotope
        --ppm '$deisotope.ppm'
        --no_isotopes '$deisotope.no_isotopes'
        --prop_1 '$deisotope.prop_1'
        --prop_2 '$deisotope.prop_2'

        ## annotate
        --ppm_annotate '$annotate.ppm_annotate'

        ## save annotated peak 
        --peak_out $peak_out
    ]]>
  </command>

  <!-- =============================================================== -->
  <inputs>

    <conditional name="process">
      <param label="Process LC-MS data with mzML or mzXML format"
             name="process_selector"
             type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true"
             help="Choose if you want to process MSI data or only visualise
                   processed MSI data." />

      <when value="TRUE">

        <param name="mzxml_file" type="data"  format="mzxml,mzml" multiple="true" 
              label="LC-MS data" optional="false"
              help="A bunch of LC-MS  data (positive or negative mode) in mzXML 
                    or mzML format." />

          <!-- parameter for function xcmsSet. findPeaks.matchedFilter is used. -->
          <param name="FWHM" type="float" value="3"
                label="FWHM of matched filtration gaussian model peak."
                help = "Approximate FWHM (in seconds) of chromatographic peaks" />

          <param name="snthresh" type="float" value="5"
                label="The signal to noise threshold"
                help = "Defining the signal to noise cutoff to be used in 
                        the chromatographic peak detection step" />

          <param name="profmethod" type="text"
                  value="binlin"
                  label="Method to use for profile generation"
                  help = "Use either 'bin' (better for centroid, default), or 
                          'binlin' (better for profile)"/>
            <!-- Supported values are "bin", "binlin", "binlinbase" and "intlin" -->

          <!-- parameter for function group. group.density (default) is used. -->
          <param name="minfrac" type="float" value="0.25"
                label="Minimum fraction"
                help = "Minimum fraction of samples necessary for it to be a 
                        valid peak group" />

          <param name="rdata" type="boolean" 
                  truevalue="TRUE" falsevalue="FALSE" checked="true" 
                  label="Save xcms results?"
                  help="Sve xcmsSet R file after runninbg xcms."/>

       </when>

      <when value="FALSE">
        <param name="xset_file" format="rdata" type="data"
               label="xcmsSet R data"
               help="xcmsSet R data file produced by xcms" />
      </when>
      
    </conditional>

    <section name="make_library" title="Making library" > 

      <param name="ionisation_mode" type="select"
              label="Specify ionisation mode"
              help="Choose 'positive' or 'negative', will determine
                    which lipid classes are in database" >
        <option value="positive" selected="True">positive</option>
        <option value="negative">negative</option>
      </param>

      <param name="fixed" type="boolean" 
              truevalue="TRUE" falsevalue="FALSE" 
              checked="false" label="SN position fixed or not"
              help="Defines if one of the SN positions is fixed, default
                    is false." />

      <param name="fixed_FA" type="float" value="16"
              label="Fixed FA"
              help="Defines the name of the fixed FA eg 16, 18.1, 20.4." />
    </section>

    <section name="deisotope"
              title="Perform deisotoping on a subset of the image">
      
      <param name="ppm" type="integer" value="3" label="Tolerance (ppm)"
              help="Tolerance (ppm) within which mass of isotope must
                    be within"/>

      <param name="no_isotopes" type="integer" value="2"
              min="1" max="2"
              label="Number of isotopes"
              help="Number of isotopes to consider (1 or 2)"/>

      <param name="prop_1" type="float" value="0.9" min="0" max="1"
              label="First Proportion"
              help="Proportion of monoisotope intensity the 1st isotope
                    intensity must not exceed"/>

      <param name="prop_2" type="float" value="0.5" min="0" max="1"
              label="Second proportion"
              help="Proportion of monoisotope intensity the 2nd isotope
                    intensity must not exceed"/>
    </section>

    <section name="annotate"
              title="Perform putative annotation on deisotoped image">
      <param name="ppm_annotate" type="integer" value="10"
              label="Specify ppm threshold for annotation"
              help="Defines ppm threshold for which |observed m/z -
                    theoretical m/z| must be less than for annotation to be
                    retained. Suggest to use same mass tolerance 
                    as bin width." /> 
    </section>
    
  </inputs>

  <!-- =============================================================== -->
  <outputs>
    <data format="tabular" name="peak_out"
          label="Annotated peak table on ${on_string}">
    </data>
    
    <data format="rdata" name="rdata_out"
          label="R running results on ${on_string}">
          <filter> 
            ((
            process['process_selector'] == True and
            process['rdata'] == True
            ))
          </filter>
    </data>

  </outputs>

  <!-- =============================================================== -->
  <tests>
    <!-- test for not processing image. Just get PCA et al -->
    <!-- 'WriteXLS' gives different size although the contents are the same -->
    <!-- different result in clustering because of randomness-->
    <test>
      <param name="process_selector" value="FALSE" /> 
      <param name="image_file" value="image_norm.tsv" />
      <param name="pca_selector" value="TRUE" /> 
      <param name="loading" value="TRUE" /> 
      <param name="slice_selector" value="TRUE" /> 
      <param name="clus_selector" value="TRUE" /> 
      <param name="intensity" value="TRUE" /> 
      <output name="pca_out" file="res/pca.pdf"  compare="sim_size"/>
      <!-- <output name="loading_out" file="res/loading.xlsx"  compare="sim_size"/> -->
      <output name="slice_out" file="res/slice.pdf"  compare="sim_size"/>
      <!-- <output name="clus_out" file="res/clus.pdf"  compare="sim_size"/> -->
      <output name="intensity_out" file="res/intensity.tsv" />
    </test>

    <!-- test for processing image. -->
    <test>
      <param name="process_selector" value="TRUE" /> 
      <param name="rem_outliers" value="TRUE" /> 
      <param name="summary" value="TRUE" /> 
      <param name="rdata" value="TRUE" /> 
      <param name="pca_selector" value="TRUE" /> 
      <param name="loading" value="TRUE" /> 
      <param name="slice_selector" value="TRUE" /> 
      <param name="clus_selector" value="TRUE" /> 
      <param name="intensity" value="TRUE" /> 
      <!-- <output name="image_out" file="res/image.tsv" /> -->
      <!-- <output name="rdata_out" file="res/r_running.rdata" compare="sim_size" /> -->
      <output name="pca_out" file="res/pca.pdf"  compare="sim_size"/>
      <!-- <output name="loading_out" file="res/loading.xlsx"  compare="sim_size"/> -->
      <!-- <output name="slice_out" file="res/slice.pdf"  compare="sim_size"/> -->
      <!-- <output name="clus_out" file="res/clus.pdf"  compare="sim_size"/> -->
      <!-- <output name="intensity_out" file="res/intensity.tsv" /> -->
    </test>
  </tests>

  <!-- =============================================================== -->
  <help>
DIMS Processing
================

Description
-----------

This tool performs Direct-infusion mass spectrometry lipidomics processing. 

Inputs
------

**\1. DIMS data**

The lipidomics data format is ``mzXML`` or ``mzML`` which can be converted 
from raw data by ``MSConvert`` of ProteoWizard_. Each file represents one 
sample or replicate. Select multiple ``mzXML`` or ``mzML`` files for 
processing. The input data will be either positive or negative mode. 
They cannot be mixed up.


.. _ProteoWizard: http://proteowizard.sourceforge.net/


**\2. Target matrix**
  
The target matrix in tabular format(``.tsv``) includes lipid target lists in
two columns. The following table is an example (positive mode):

========    ==========================================
mz          name
========    ==========================================
185.1547    FA(11:0)_[M-H]1-
197.1547    FA(12:1)_[M-H]1-
199.1704    FA(12:0)_[M-H]1-
209.1183    OCT(C12H18O3)_jasmonic acid_[M-H]1-
211.134     OCT(C12H20O3)_dihydrojasmonic_acid_[M-H]1-
213.186     FA(13:0)_[M-H]1-
215.1653    FA(12:0)-OH_[M-H]1-
223.134     OCT(C13H20O3)_methyl_jasmonate_[M-H]1-
225.1132    OCT(C12H18O4)_[M-H]1-
225.186     FA(14:1)_[M-H]1-
========    ==========================================

Note that the target matrix file should be either positive or negative,
depending on the mode of DIMS data input.


Parameters
----------

Select time range
~~~~~~~~~~~~~~~~~

- The time range for positive mode is 20 - 60s
- The time range for negative mode is 80 - 120s

Select m/z range
~~~~~~~~~~~~~~~~

- Select m/z range of 200 - 1200 for positive mode 
- Select m/z range of 185 - 1200 for negative mode

Select m/z window size
~~~~~~~~~~~~~~~~~~~~~~

Select m/z window height for peak finding. The default value is 0.01.


Outputs
----------

Signal Peak Table
~~~~~~~~~~~~~~~~~

The default output is the signal table in tabular format:

====================================== ========  ===========   ========   ==========   
name                                   mz        pos-001       pos-002    pos-003     
====================================== ========  ===========   ========   ==========   
PS_32:5_[M+Na]1+                       748.416   0             0          0           
PE_37:7_[M+H]1+ / PA_39:8_[M+NH4]1+    748.4912  104.3298294   0          136.4149127 
PS_33:1_[M+H]1+ / PG_33:3_[M+NH4]1+    748.5123  755.8055022   0          539.1916569 
PE-P_38:6_[M+H]1+                      748.5276  862.2107571   0          1028.002626 
PC-O_34:0_[M+H]1+ / PE-O_37:0_[M+H]1+  748.6215  0             0          0           
TG_43:3_[M+NH4]1+                      748.645   0             0          0           
DG_44:3_[M+NH4]1+                      748.6814  13201.64570   8790.560   0
2H-IS_PE_[M+H]1+                       748.7244  113052.2131   0          81301.89354 
====================================== ========  ===========   ========   ==========   

Deviations table
~~~~~~~~~~~~~~~~

The m/z deviation table, the same format as signal peak table, will be
produced if **Produce m/z deviations table?** is TRUE. 

Individual table
~~~~~~~~~~~~~~~~

An Excel ``XLSX`` file containing each sample's signals and m/z deviations
will be produced if **Produce signal and deviation for each individual
sample?** is set as TRUE. This file cannot shown in Galaxy but can be
downloaded.


  </help>
  
  <citations>
    <citation type="doi">10.1007/s11306-017-1252-5</citation>
  </citations>

</tool>
